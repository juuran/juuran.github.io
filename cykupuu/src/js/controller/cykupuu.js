import*as Util from"../etc/util.js";import{InputHakuKentta,ButtPainike,OnOffPainike}from"../view/komponentit.js";import{FormHenkiloa,FormSuhdetta,FormAsetukset,FormPikanappaimet}from"../view/popupit.js";import{luoHenkiloSolmutDatasta,luoSuhdeSolmutJaKaaretDatasta,lisaaSuhde,lisaaHenkilo,luoHenkiloTyhjasta,muutaHenkiloa,muutaSuhdetta,poistaHenkiloSolmu,poistaSuhdeSolmu}from"../business/alkiot.js";import*as Boilerplate from"../cytoscape/boilerplate.js";import*as Main from"./main.js";import{asetukset,tila}from"./main.js";import{panoroiGraafi,tallennaTamanhetkinenPanorointi,zoomaa,voiZoomata,piirraTarkemmatTiedot}from"../view/piirtoalgoritmit.js";import{Sukulaisuus}from"../view/sukulaisuus.js";let cy;var that;class Cykupuu{static SUHTEEN_MARGIN;static PIIRTO_STEP;static ANIMAATIO_PITUUS_SYNTYMA;static ANIMAATIO_PITUUS_KUOLEMA;static UUSI_SOLMU_TUNNISTE;static POPUP_TALLENNA_TUNNISTE;static POPUP_KUMOA_TUNNISTE;static DEBUG_LOG;static GRID_STEP;static ZOOM_KERROIN;static ZOOM_MAX;static ZOOM_MIN;static VAPAA_KENTTA_LYHYT_PITUUS;static VAPAA_KENTTA_TAYSI_PITUUS;UUDEN_VANHEMMAN_NAPIN_TEKSTI;UUDEN_LAPSEN_NAPIN_TEKSTI;UUDEN_YLAVIRTA_SUHTEEN_TEKSTI;UUDEN_ALAVIRTA_SUHTEEN_TEKSTI;#a;nappiHakuKentta;inputHakuKentta;pikanappaimet;nappiPoistaSolmu;#t;#i;#e;#u;nappiUndo;nappiRedo;nappiMuokkaa;nappiImport;nappiExport;nappiResetPan;nappiSavePan;#n;nappiNaytaSukulaisuus;nappiNaytaTiedot;popupMuokkaaHenkiloa;popupMuokkaaSuhdetta;popupMuokkaaUuttaHenkiloa;popupMuokkaaUuttaSuhdetta;nappiZoomSisaan;nappiZoomUlos;#s;#o;#l;#p;constructor(a,t,i,e,u,n,s,o,l,p,k){that=this,Cykupuu.SUHTEEN_MARGIN=a,Cykupuu.PIIRTO_STEP=t,Cykupuu.ANIMAATIO_PITUUS_SYNTYMA=.9*i,Cykupuu.ANIMAATIO_PITUUS_KUOLEMA=.9*e,Cykupuu.UUSI_SOLMU_TUNNISTE="muokkaaUutta",Cykupuu.POPUP_TALLENNA_TUNNISTE="TALLENNA",Cykupuu.POPUP_KUMOA_TUNNISTE="KUMOA",Cykupuu.DEBUG_LOG=u,Cykupuu.GRID_STEP=n,Cykupuu.ZOOM_KERROIN=s,Cykupuu.ZOOM_MAX=o,Cykupuu.ZOOM_MIN=l,Cykupuu.VAPAA_KENTTA_LYHYT_PITUUS=p,Cykupuu.VAPAA_KENTTA_TAYSI_PITUUS=k,this.UUDEN_VANHEMMAN_NAPIN_TEKSTI="Vanhempi ‚¨ÜÔ∏è",this.UUDEN_LAPSEN_NAPIN_TEKSTI="Lapsi ‚¨áÔ∏è",this.UUDEN_YLAVIRTA_SUHTEEN_TEKSTI="Suhde ‚¨ÜÔ∏è",this.UUDEN_ALAVIRTA_SUHTEEN_TEKSTI="Suhde ‚¨áÔ∏è";const h=document.getElementById("hakukentanSpan"),d=document.getElementById("graafinMuokkausSpan"),r=document.getElementById("undoRedoSpan"),S=document.getElementById("saveLoadSpan"),c=document.getElementById("panSpan"),m=document.getElementById("nayttamisNappiSpan"),U=document.getElementById("popupit"),T=document.getElementById("rajauksenNapit");this.#a=document.getElementById("statusbar"),this.nappiHakuKentta=new OnOffPainike("üîé",this.painaNappiaHaku,"click",h,"hakuNappi",!1,!1),this.inputHakuKentta=new InputHakuKentta(this.hakuKentanHakulogiikka,"input",h),this.pikanappaimet=new FormPikanappaimet(this.naytaPikanapit,U),this.nappiPoistaSolmu=new ButtPainike("üóëÔ∏è",this.poistaValitutSolmut,"click",d),this.#t=new ButtPainike(this.UUDEN_VANHEMMAN_NAPIN_TEKSTI,this.uudenPalluranLogiikka,"click",d),this.#i=new ButtPainike(this.UUDEN_LAPSEN_NAPIN_TEKSTI,this.uudenPalluranLogiikka,"click",d),this.#e=new ButtPainike(this.UUDEN_YLAVIRTA_SUHTEEN_TEKSTI,this.uudenPalluranLogiikka,"click",d),this.#u=new ButtPainike(this.UUDEN_ALAVIRTA_SUHTEEN_TEKSTI,this.uudenPalluranLogiikka,"click",d),this.nappiMuokkaa=new ButtPainike("‚úèÔ∏è",this.avaaMuokkaus,"click",d),this.#n=new ButtPainike("‚ûïüßç",this.luoEnsimmainenHenkilo,"click",d),this.nappiUndo=new OnOffPainike("‚Ü©Ô∏è",this.undoRedoKuuntelija,"click",r,"undo"),this.nappiRedo=new OnOffPainike("‚Ü™Ô∏è",this.undoRedoKuuntelija,"click",r,"redo"),this.nappiAsetukset=new ButtPainike("‚öôÔ∏è",(()=>this.popupAsetukset.up(asetukset)),"click",S,"ratas"),this.popupAsetukset=new FormAsetukset(this.tallennaTaiKumoaAsetukset,U),this.nappiImport=new ButtPainike("üíΩ‚§¥ Lataa...",Main.lataaTiedosto,"click",S),this.nappiExport=new ButtPainike("‚§µüíæ Tallenna",Main.tallennaTiedosto,"click",S),this.nappiResetPan=new ButtPainike("üñ•Ô∏è",(()=>{panoroiGraafi(tila.naytaTila().panorama),this.kirjoitaStatus("Oletusn√§kym√§ palautettu.")}),"click",c,"resetPanButton"),this.nappiSavePan=new ButtPainike("üñ•Ô∏èüíæ",tallennaTamanhetkinenPanorointi,"click",c,"savePanButton"),this.nappiNaytaSukulaisuus=new OnOffPainike("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ (Œ≤eta)",this.painaNappiaSukulaisuus,"click",m,"sukulaku",!0,asetukset._naytaSukulaisuus()),this.nappiNaytaTiedot=new OnOffPainike("‚ÑπÔ∏è",this.painaNappiaNaytaInfo,"click",m,"info",!1,asetukset._naytaValitunTiedot()),this.popupMuokkaaHenkiloa=new FormHenkiloa(this.tallennaTaiKumoaMuokkaus,U),this.popupMuokkaaSuhdetta=new FormSuhdetta(this.tallennaTaiKumoaMuokkaus,U),this.popupMuokkaaUuttaHenkiloa=new FormHenkiloa(this.tallennaTaiKumoaMuokkaus,U,`${Cykupuu.UUSI_SOLMU_TUNNISTE}Henkiloa`),this.popupMuokkaaUuttaSuhdetta=new FormSuhdetta(this.tallennaTaiKumoaMuokkaus,U,`${Cykupuu.UUSI_SOLMU_TUNNISTE}Suhdetta`),this.nappiZoomSisaan=new OnOffPainike("‚ûï",(()=>{zoomaa("sis√§√§n"),this.enabloiZoomit()}),"click",T,"zoomaaSisaan"),this.nappiZoomUlos=new OnOffPainike("‚ûñ",(()=>{zoomaa("ulos"),this.enabloiZoomit()}),"click",T,"zoomaaUlos"),this.#s=!0,this.#o=null,this.#l=null,this.#p=null,cy=Boilerplate.createCytoscape(),this.uiInit()}uiInit(){this.nappiAsetukset.up(),this.nappiImport.up(),this.nappiExport.up(),this.nappiResetPan.up(),this.nappiSavePan.up(),this.enabloiZoomit(),this.nappiNaytaTiedot.enable(),this.naytaUiNappulatValitulleSolmulle()}painaNappiaHaku(a){that.inputHakuKentta.isUp()?(that.nappiHakuKentta.setPressed(!1),that.inputHakuKentta.down(),that.valitakoHaullaLoydetty("valitse")):(that.nappiHakuKentta.setPressed(!0),that.valittunaEnnenHakuaTalteen(),that.inputHakuKentta.up())}hakuKentanHakulogiikka(a){const t=a.currentTarget.value.toLocaleLowerCase().trim();if(t.length<3)return;const i=cy.nodes();if(!(i.length<1))for(const a of Object.values(i)){if(!a.scratch()._itse.henkilo)continue;let i=!0;const e=a.scratch()._itse.henkilo,u=e.etunimet.toLocaleLowerCase()+" "+e.sukunimet.toLocaleLowerCase(),n=t.indexOf('"'),s=t.indexOf('"',n+1);if(n>-1&&s>-1){const a=t.substring(n+1,s).toLocaleLowerCase();u.includes(a)||(i=!1)}else{const a=t.split(" ");for(const t of a)u.includes(t)||(i=!1)}if(i)return cy.nodes(":selected").unselect(),a.select(),that.#l=a,void that.naytaUiNappulatValitulleSolmulle()}}naytaPikanapit(){that.pikanappaimet.isUp()?that.pikanappaimet.down(!0):that.pikanappaimet.up()}valittunaEnnenHakuaTalteen(){const a=cy.nodes(":selected");a.length>0&&(that.#o=a),that.#l=null}valitakoHaullaLoydetty(a){if("valitse"===a){if(!that.#l)return that.inputHakuKentta.sheikkaa(),void that.kirjoitaStatus("Haulla ei l√∂ytynyt vastaavannimist√§ henkil√∂√§.");that.#l.select(),that.#l.flashClass("highlighted",400),that.kirjoitaStatus("Valitaan l√∂ydetty henkil√∂."),that.#o&&that.#o.unselect()}else"kumoa"===a&&(that.#l&&that.#l.unselect(),that.#o&&that.#o.select());that.#l=null,that.#o=null,that.inputHakuKentta.down(),that.nappiHakuKentta.setPressed(!1),that.naytaUiNappulatValitulleSolmulle()}painaNappiaSukulaisuus(a){that.#p=new Sukulaisuus(tila.naytaTila().henkilot,tila.naytaTila().suhteet);const t=cy.nodes(":selected");if(asetukset._naytaValitunTiedot(!1)&&that.paivitaValituilleNaytaInfo(t),that.nappiNaytaTiedot.setPressed(!1),that.nappiNaytaTiedot.disable(),that.nappiNaytaSukulaisuus.setPressed(asetukset.vaihtele_naytaSukulaisuus()),!1===asetukset._naytaSukulaisuus())that.#p.piirraSukulaisuusNimike("nollaa"),that.nappiNaytaTiedot.enable();else if(1===t.length){const a=t[0].scratch()._itse.henkilo;that.#p.piirraSukulaisuusNimike("piirr√§",a)}that.naytaUiNappulatValitulleSolmulle()}painaNappiaNaytaInfo(a){that.nappiNaytaTiedot.setPressed(asetukset.vaihtele_naytaValitunTiedot());const t=asetukset._naytaValitunTiedot()?"N√§ytet√§√§n valitun henkil√∂n/suhteen tiedot.":"N√§ytet√§√§n henkil√∂n/suhteen tiedot vain kursorin ollessa palluran p√§√§ll√§.";that.kirjoitaStatus(t),that.paivitaValituilleNaytaInfo()}poistaValitutSolmut(a,t=!1){!t&&that.#s&&(alert("Huom! T√§m√§ poistaa valitut pallurat. Niist√§ voidaan palauttaa vain niin monta kuin undo historia sallii."),that.#s=!1);const i=cy.nodes(":selected");i.forEach((a=>that.poistaYksiSolmu(a.scratch()._itse,a))),i.unselect(),that.naytaUiNappulatValitulleSolmulle()}luoEnsimmainenHenkilo(a){const t=luoHenkiloTyhjasta({x:0,y:0});cy.getElementById(t.id).select(),that.popupMuokkaaUuttaHenkiloa.up(t),cy.zoom(1),cy.center()}uudenPalluranLogiikka(a){const t=cy.nodes(":selected");if(1!==t.length)return;const i=a.currentTarget.textContent,e=t.scratch()._itse;let u;if(e.suhde)if(i===that.UUDEN_LAPSEN_NAPIN_TEKSTI)u=lisaaHenkilo("lapsi",e.suhde,that.onkoLapsiBiologisestiOma());else{if(i!==that.UUDEN_VANHEMMAN_NAPIN_TEKSTI)throw new Error("Lis√§tt√§v√§ uusi suhde ei sis√§ll√§ kumpaakaan taikasanaa. T√§m√§ on bugi!");u=lisaaHenkilo("aikuinen",e.suhde)}else if(e.henkilo)if(i===that.UUDEN_YLAVIRTA_SUHTEEN_TEKSTI)u=lisaaSuhde("yl√§virtasuhde",e.henkilo,that.onkoLapsiBiologisestiOma());else{if(i!==that.UUDEN_ALAVIRTA_SUHTEEN_TEKSTI)throw new Error("Lis√§tt√§v√§ uusi suhde ei sis√§ll√§ kumpaakaan taikasanaa. T√§m√§ on bugi!");u=lisaaSuhde("alavirtasuhde",e.henkilo)}that.avaaLomakeLuodulleSolmulle(u,t)}avaaLomakeLuodulleSolmulle(a,t){t.unselect(),cy.getElementById(a.id).select();const i=t.scratch()._itse;i.suhde?that.popupMuokkaaUuttaHenkiloa.up(a):i.henkilo&&that.popupMuokkaaUuttaSuhdetta.up(a)}avaaMuokkaus(a){const t=cy.nodes(":selected");if(1!==t.length)return;const i=t[0].scratch()._itse;i.henkilo?(that.popupMuokkaaHenkiloa.up(i.henkilo),that.popupMuokkaaSuhdetta.down()):i.suhde&&(that.popupMuokkaaHenkiloa.down(),that.popupMuokkaaSuhdetta.up(i.suhde))}tallennaTaiKumoaAsetukset(a){let t=!0;const i=a.currentTarget.name;let e=!1;if(i===Cykupuu.POPUP_KUMOA_TUNNISTE)t=!1;else if(i===Cykupuu.POPUP_TALLENNA_TUNNISTE){if(Util.log("Tallennetaan asetukset."),!that.popupAsetukset.isUp())throw new Error("Asetukset pit√§isi tallentaa, mutta ne eiv√§t ole auki!");const a=that.popupAsetukset;asetukset.naytaLaajatTiedot(a.naytaLaajatTiedotValitsin.getValue())&&(e=!0,that.paivitaValituilleNaytaInfo(),that.kirjoitaStatus("Asetuksia muutettu.")),asetukset.offlineMoodi(a.offlineMoodiValitsin.getValue())&&(e=!0,Main.hallinnoiData()),asetukset.statusbarinDebugtieto(a.statusbarDebugValitsin.getValue())&&(e=!0,asetukset.statusbarinDebugtieto()?that.kirjoitaStatus("Debug tietojen n√§ytt√§minen p√§√§ll√§.",!0):that.kirjoitaStatus("Debug tietoja ei en√§√§ n√§ytet√§."))}that.popupAsetukset.down(t),!1===e&&that.kirjoitaStatus("Asetuksia ei muutettu.")}tallennaTaiKumoaMuokkaus(a){let t=!1;const i=a.currentTarget.name,e=a.target.parentElement.parentElement.id;if(i===Cykupuu.POPUP_TALLENNA_TUNNISTE){if(Util.logDebug("Tallennetaan muutokset solmun tietoihin..."),that.tallennaMuutokset()){if(that.kirjoitaStatus("Tiedot p√§ivitetty."),asetukset._naytaSukulaisuus()){const a=that.#p.piirraSukulaisuusNimike("nollaa");that.#p=new Sukulaisuus(tila.naytaTila().henkilot,tila.naytaTila().suhteet),that.#p.piirraSukulaisuusNimike("piirr√§",a)}}else that.kirjoitaStatus("Tietoja ei muutettu.");e.includes(Cykupuu.UUSI_SOLMU_TUNNISTE)&&that.kirjoitaStatus("Uusi luotu!"),Main.synkronoiMuutokset(),t=!0,Util.logDebug("Tallennettu solmun tiedot onnistuneesti.")}else i===Cykupuu.POPUP_KUMOA_TUNNISTE&&(e.includes(Cykupuu.UUSI_SOLMU_TUNNISTE)?(Util.logDebug("Kyseess√§ uusi solmu, joten poistetaan luotu placeholder solmu."),that.poistaValitutSolmut(null,!0),that.kirjoitaStatus("Uuden luominen kumottu.")):(Util.logDebug("Solmun tietoja ei tallennettu."),that.kirjoitaStatus("Muutokset kumottiin.")));that.popupMuokkaaHenkiloa.down(t),that.popupMuokkaaSuhdetta.down(t),that.popupMuokkaaUuttaHenkiloa.down(t),that.popupMuokkaaUuttaSuhdetta.down(t),that.naytaUiNappulatValitulleSolmulle()}tallennaMuutokset(){const a=cy.nodes(":selected");if(that.popupMuokkaaHenkiloa.isUp()||that.popupMuokkaaUuttaHenkiloa.isUp()){const t=that.popupMuokkaaHenkiloa.isUp()?that.popupMuokkaaHenkiloa:that.popupMuokkaaUuttaHenkiloa;return muutaHenkiloa(a,t.etunimetKentta.getValue(),t.sukuNimetKentta.getValue(),t.syntAikaKentta.getValue(),t.kuolAikaKentta.getValue(),t.syntPaikkaKentta.getValue(),t.paaAsPaikkaKentta.getValue(),t.aidinkieliKentta.getValue(),t.heimoKentta.getValue(),t.vapaaTietoKentta.getValue())}if(that.popupMuokkaaSuhdetta.isUp()||that.popupMuokkaaUuttaSuhdetta.isUp()){const t=that.popupMuokkaaSuhdetta.isUp()?that.popupMuokkaaSuhdetta:that.popupMuokkaaUuttaSuhdetta;return muutaSuhdetta(a,t.nimikeKentta.getValue(),t.yhdessaValitsin.getValue(),t.naimisissaValitsin.getValue())}}undoRedoKuuntelija(a){"undo"===a.currentTarget.id?that.undo():"redo"===a.currentTarget.id&&that.redo()}naytaUiNappulatValitulleSolmulle(a){const t=cy.nodes(":selected");if(1===t.length){const a=t[0],i=a.scratch()._itse;let e="";Util.isDebugLog()&&(e=`${i.toString()} (x: ${a.json().position.x}, y: ${a.json().position.y})`),i.henkilo?(this.enabloiNaytaSukulaisuus("enable"),this.#n.down(!0),this.nappiPoistaSolmu.up(),this.nappiMuokkaa.up(),this.#t.down(!0),this.#i.down(!0),this.#e.down(!0),this.#u.down(!0),this.#e.up(),this.#u.up(),this.kirjoitaStatus(e,!0)):i.suhde&&(this.enabloiNaytaSukulaisuus("disable"),this.#n.down(!0),this.nappiPoistaSolmu.up(),this.nappiMuokkaa.up(),this.#t.down(!0),this.#i.down(!0),this.#t.up(),this.#i.up(),this.#e.down(!0),this.#u.down(!0),this.kirjoitaStatus(e,!0)),this.paivitaValituilleNaytaInfo(t)}else t.length>1?(this.enabloiNaytaSukulaisuus("disable"),this.#n.down(!0),this.nappiPoistaSolmu.up(),this.nappiMuokkaa.down(),this.#t.down(),this.#i.down(),this.#e.down(),this.#u.down(),this.kirjoitaStatus("Valitse vain yksi solmu n√§ytt√§√§ksesi tietoja.",!0),this.paivitaValituilleNaytaInfo(t)):t.length<1&&(0===cy.nodes().length?this.#n.up():this.#n.down(!0),this.enabloiNaytaSukulaisuus("disable"),this.nappiPoistaSolmu.down(),this.nappiMuokkaa.down(),this.#t.down(),this.#i.down(),this.#e.down(),this.#u.down());if(tila.hasUndo()?this.nappiUndo.enable():this.nappiUndo.disable(),tila.hasRedo()?this.nappiRedo.enable():this.nappiRedo.disable(),Util.isDebugLog()){const a=cy.edges(":selected");if(1!=a.length)return;const t=a.scratch()._itse.suhdeLiitos;t&&this.kirjoitaStatus(t.toString(),!0)}}enabloiNaytaSukulaisuus(a){asetukset._naytaSukulaisuus()||"enable"===a?this.nappiNaytaSukulaisuus.enable():"disable"===a&&this.nappiNaytaSukulaisuus.disable()}enabloiZoomit(a={}){const t=a.zoom;voiZoomata("sis√§√§n",t)?this.nappiZoomSisaan.enable():this.nappiZoomSisaan.disable(),voiZoomata("ulos",t)?this.nappiZoomUlos.enable():this.nappiZoomUlos.disable()}paivitaValituilleNaytaInfo(a=null){(a=a||cy.nodes(":selected")).length>0&&a.forEach((a=>piirraTarkemmatTiedot({target:a},"sama")))}piirraGraafiUudestaan(){const a={zoom:cy.zoom(),pan:{x:cy.pan().x,y:cy.pan().y}};cy.destroy(),cy=Boilerplate.createCytoscape(),Boilerplate.createLayout("preset").run(),cy.pan(a),luoHenkiloSolmutDatasta(tila.naytaTila().henkilot),luoSuhdeSolmutJaKaaretDatasta(tila.naytaTila().suhteet),this.uiInit()}poistaYksiSolmu(a,t){a.henkilo?poistaHenkiloSolmu(a.henkilo,t):a.suhde&&poistaSuhdeSolmu(a.suhde,t)}undo(){tila.undo(),asetukset.statusbarinDebugtieto()?this.kirjoitaStatus(`Undo! tila: ${tila._undoLista.toString()}`,!0):this.kirjoitaStatus("Undo! Palautettu edellinen tila.",!1),this.piirraGraafiUudestaan(),Main.asetaCytoscapenKuuntelijat()}redo(){tila.redo(),asetukset.statusbarinDebugtieto()?this.kirjoitaStatus(`Redo! tila: ${tila._undoLista.toString()}`,!0):this.kirjoitaStatus("Redo! Asetettu seuraava tila.",!1,!1),this.piirraGraafiUudestaan(),Main.asetaCytoscapenKuuntelijat()}valitseSolmut(a){"kaikki"===a?cy.elements().select():"eimit√§√§n"===a&&cy.elements().unselect(),this.naytaUiNappulatValitulleSolmulle()}luoSolmu(a){const t=cy.nodes(":selected");if(t.length>1)return void alert("Sinulla oli monta solmua valittuna, kun yritit luoda uuttaa henkil√∂√§ tai suhdetta. Vain yksi voi olla valittuna.");if(t.length<1)return;const i=t[0].scratch()._itse;"yl√∂s"===a?i.henkilo?that.#e.underlyingElement.click():i.suhde&&that.#t.underlyingElement.click():"alas"===a&&(i.henkilo?that.#u.underlyingElement.click():i.suhde&&that.#i.underlyingElement.click())}onkoLapsiBiologisestiOma(){return!0}kirjoitaStatus(a,t=!1){const i=t?`‚ùóüêû ${a}`:a;t&&!asetukset.statusbarinDebugtieto()||(this.#a.textContent=`[${Util.timeToFIString(new Date)}] ${i}`)}}export{Cykupuu,cy};