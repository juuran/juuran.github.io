/**
 * Copyright (C) Juuso VÃ¤limaa - All Rights Reserved
 *
 * The intellectual and technical concepts contained herein,
 * excluding the cytoscape.js library, are proprietary to Juuso
 * VÃ¤limaa. Unauthorized copying of this source code or any of
 * its files, via any medium, is strictly prohibited, unless
 * prior written permission is obtained.
 *
 */

"use strict";import{Cykupuu,cy}from"./cykupuu.js";import{Suhde}from"../model/suhde.js";import{Henkilo}from"../model/henkilo.js";import{asetaGridiin}from"../view/piirtoalgoritmit.js";import*as Util from"../etc/util.js";import{Tila}from"../business/tila.js";import{nappaimienKuuntelija,forminNappaimienKuuntelija,hakukentanKuuntelija}from"../etc/pikanapit.js";import{panoroiGraafi,piirraTarkemmatTiedot}from"../view/piirtoalgoritmit.js";import{Asetukset}from"../etc/asetukset.js";const TIMEOUT_FETCH_GET=6,TIMEOUT_FETCH_POST=8,YRITYKSIA=13,SERVER_SYNC_DELAY_SEC=10,HOST="http://localhost:8080";let tallennusTimerId,_isDirty=!1;const tila=new Tila(32,{henkilot:new Map,suhteet:new Map}),asetukset=luoAsetukset(),suhteenMargin=50,piirtoStep=100,synnyinPituus=.333,kuolinPituus=.292,debugLogging=!0,snapToGridStep=50,zoomausKerroin=1.5,vapaaKentanPituus=240,vapaaKentanTaysPituus=4096,maxZoom=3.375,minZoom=1*1.5**-5,cykupuu=new Cykupuu(50,100,.333,.292,true,50,1.5,3.375,minZoom,240,4096);function asetaKuuntelijat(){kytkeNappaimienKuuntelija(!0),kytkeHakukentanKuuntelija(!0),kytkeForminNappaimienKuuntelija(!1)}function asetaCytoscapenKuuntelijat(){cy.addListener("select",(async t=>{await Util.sleep(.01),cykupuu.naytaUiNappulatValitulleSolmulle()})),cy.addListener("unselect",(async t=>{await Util.sleep(.01),piirraTarkemmatTiedot(t,"piilota"),cykupuu.naytaUiNappulatValitulleSolmulle()})),cy.addListener("mouseover",(async t=>{piirraTarkemmatTiedot(t,"mouseover")})),cy.addListener("mouseout",(async t=>{piirraTarkemmatTiedot(t,"mouseout")})),cy.addListener("dragfree",asetaGridiin)}function kytkeNappaimienKuuntelija(t){t?document.addEventListener("keydown",nappaimienKuuntelija):document.removeEventListener("keydown",nappaimienKuuntelija)}function kytkeHakukentanKuuntelija(t){t?document.addEventListener("keydown",hakukentanKuuntelija):document.removeEventListener("keydown",hakukentanKuuntelija)}function kytkeForminNappaimienKuuntelija(t){t?document.addEventListener("keydown",forminNappaimienKuuntelija):document.removeEventListener("keydown",forminNappaimienKuuntelija)}function createBusinessId(){return crypto.randomUUID()}function tabinSulkemisKuuntelija(t){t.preventDefault(),t.returnValue=!0}function makeDirty(){_isDirty=!0,window.addEventListener("beforeunload",tabinSulkemisKuuntelija)}function nollaaServerSynkkausTimer(){Util.clearTimer(tallennusTimerId),tallennusTimerId=null}function clearDirty(){_isDirty=!1,window.removeEventListener("beforeunload",tabinSulkemisKuuntelija),asetukset.offlineMoodi()||nollaaServerSynkkausTimer()}function isDirty(){return _isDirty}function luoAsetukset(){let t=new Asetukset({naytaLaajatTiedot:!1,offlineMoodi:!0,_naytaValitunTiedot:!1,_naytaSukulaisuus:!1,statusbarinDebugtieto:!1,_panorama:{pan:{x:100,y:100},zoom:1}});return t.loadFromCookiesIfFound(),t._naytaSukulaisuus(!1),t}function synkronoiMuutokset(){makeDirty(),asetukset.offlineMoodi()?Util.logDebug("synkronoiMuutokset(): offline. Dirty tÃ¤ppÃ¤ voidaan puhdistaa tallentamalla manuaalisesti."):(Util.logDebug("synkronoiMuutokset(): online. Dirty tÃ¤ppÃ¤ puhdistetaan synkronoimalla palvelimen kanssa 10 sekunnin pÃ¤Ã¤stÃ¤."),tallennusTimerId&&Util.clearTimer(tallennusTimerId),tallennusTimerId=Util.setFunctionForTimer(yritaTallentaaServerille,10),(async()=>{await Util.sleep(.2),cykupuu.kirjoitaStatus("Muutoksia tehty, tallennetaan 10 sek pÃ¤Ã¤stÃ¤.",!1)})())}async function yritaTallentaaServerille(){await yritaViedaDataa(HOST)?(clearDirty(),cykupuu.kirjoitaStatus("âœ”ï¸ Tiedot tallennettu palvelimelle.")):(cykupuu.kirjoitaStatus("âŒ Palvelinyhteys katki, tallentaminen epÃ¤onnistui."),Util.log(`Ei voitu tallentaa serverille, isDirty(): ${isDirty()}`))}async function yritaViedaDataa(t){const a=luoTallennettavaData();let e;try{e=await Util.postaaDataaServerille(`${t}/api/henkilot-ja-suhteet`,8,a)}catch(t){return kasitteleVirhe(t,"viedessÃ¤ dataa servulle")}if(!e.ok){const t=e.statusText?`: ${e.statusText}`:"";return Util.logError(`Yritettiin viedÃ¤ dataa, mutta se epÃ¤nnistui (status ${e.status})${t}`),!1}return!0}async function hallinnoiData(){if(asetukset.offlineMoodi())Util.log("Offline-tilassa, joten ei haeta dataa graafiin, mutta alustetaan muutoin cykupuu."),luoCytoscapeUusillaTiedoilla(null,null),nollaaServerSynkkausTimer(),0!==cy.nodes().length?cykupuu.kirjoitaStatus("ğŸŸ£ Offline-tila pÃ¤Ã¤llÃ¤."):(await Util.sleep(.5),cykupuu.kirjoitaStatus("ğŸŸ£ Offline-tilassa. Tervetuloa cykupuuhun â€“ aloita lataamalla tiedosto tai luomalla ensimmÃ¤inen henkilÃ¶."));else{await Util.sleep(.5),cykupuu.kirjoitaStatus("â¤µï¸ Online-tilassa. YritetÃ¤Ã¤n ladata tietoja palvelimelta..."),Util.log("Online-tilassa, joten haetaan data serveriltÃ¤. YritetÃ¤Ã¤n 13 kertaa 6 sek timeouteilla.");const t="â›“ï¸â€ğŸ’¥ Palvelimeen ei saatu yhteyttÃ¤, yritetÃ¤Ã¤n uudelleen tietojen latausta";let a=".",e=!1,i=0;do{if(e=await yritaHakeaDataGraafiin(HOST),asetukset.offlineMoodi())return void Util.log("Synkkausta olisi yritetty nyt, mutta se oli keskeytetty offline-tilan vuoksi.");if(e)break;cykupuu.kirjoitaStatus(`${t}${a}`),a+=".",i++}while(!e&&i<13);e?cykupuu.kirjoitaStatus("ğŸŸ¢ Online-tilassa. Tiedot onnistuneesti haettu palvelimelta."):cykupuu.kirjoitaStatus("âŒ Palvelinyhteys katki, tietoja ei voi tÃ¤llÃ¤ hetkellÃ¤ hakea.")}await Util.sleep(15*Math.random()+5+15),cykupuu.kirjoitaStatus("âŒ¨ï¸ PikanÃ¤ppÃ¤imet saat nÃ¤kyviin painamalla shift + F1 tai 'H'")}async function yritaHakeaDataGraafiin(t){try{const a=await Util.noudaDataaServerilta(`${t}/api/suhteet`,6),e=await Util.noudaDataaServerilta(`${t}/api/henkilot`,6),i=JSON.parse(a,Suhde.reviver);return luoCytoscapeUusillaTiedoilla(JSON.parse(e,Henkilo.reviver),i),!0}catch(t){return kasitteleVirhe(t,"haettaessa dataa servulta")}}async function lataaTiedosto(){var t=document.createElement("input");t.type="file",t.onchange=async t=>{1!==t.target.files.length&&alert("Voidaan ladata vain yksi tiedosto!");const a=t.target.files[0],e=await a.text();let i,n;try{i=JSON.parse(e,Henkilo.reviver),n=JSON.parse(e,Suhde.reviver)}catch(t){throw alert(`SisÃ¤llÃ¶n muuttaminen sukupuutiedoksi ei ole mahdollista. Saatiin virhe:\n\n${t.message}`),cykupuu.kirjoitaStatus("âŒ Tiedosto voi olla korruptoitunut, lataaminen epÃ¤onnistui.",!1),new Error(`Tiedoston lataaminen epÃ¤onnistui, koska saatiin virhe:\n\n${t.message}`)}const u=i.panoData;if(u)try{const t={zoom:u.zoom,pan:{x:u.pan.x,y:u.pan.y}};asetukset._panorama(t)}catch(t){Util.logWarn(`Panorama data oli vÃ¤Ã¤rÃ¤ssÃ¤ muodossa! Error: ${t.message}`)}clearDirty(),luoCytoscapeUusillaTiedoilla(i.henkiloData,n.suhdeData),cykupuu.kirjoitaStatus("âœ”ï¸ Tiedot onnistuneesti ladattu tiedostosta.",!1)},t.click()}async function tallennaTiedosto(){const t=luoTallennettavaData(!1);if(0===t.henkiloData.length&&0===t.suhdeData.length)return void alert("Tallennettavaa sisÃ¤ltÃ¶Ã¤ ei ole, joten talletaminen keskeytetÃ¤Ã¤n.");const a=JSON.stringify(t),e=`sukupuu_${(new Date).toISOString()}.json`;var i=new Blob([a],{type:"file"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(i,e);else{var n=document.createElement("a"),u=URL.createObjectURL(i);n.href=u,n.download=e,document.body.appendChild(n),n.click(),setTimeout((function(){document.body.removeChild(n),window.URL.revokeObjectURL(u)}),0)}cykupuu.kirjoitaStatus("ğŸ’¾ Tiedot onnistuneesti tallennettu tiedostoksi.",!1),clearDirty()}function luoTallennettavaData(t=!0){const a=tila.naytaTila();let e;const i=Array.from(a.henkilot.values()),n=Array.from(a.suhteet.values());return e=t?{henkiloData:i,suhdeData:n}:{henkiloData:i,suhdeData:n,panoData:asetukset._panorama()},e}function luoCytoscapeUusillaTiedoilla(t,a){t&&a&&asetaSukupuuTiedot(t,a),cykupuu.piirraGraafiUudestaan(),asetaCytoscapenKuuntelijat()}function asetaSukupuuTiedot(t,a){const e=new Map,i=new Map;if(Array.isArray(t))t.forEach((t=>{e.set(t.id,t)})),a.forEach((t=>{i.set(t.id,t)}));else{for(const a of Object.values(t))e.set(a.id,a);for(const t of Object.values(a))i.set(t.id,t)}if(0===e.size&&0===i.size)throw new SyntaxError("Tiedosto ei sisÃ¤llÃ¤ lainkaan sukupuun tietoja.");const n=tila.naytaTila();tila.muutaTilaa({...n,henkilot:e,suhteet:i})}function kasitteleVirhe(t,a){return"AbortError"===t.name?Util.logDebug(`Saatiin timeout ${a}.`):(Util.log(`Saatiin muu kuin timeout-virhe ${a}:`),Util.logError(t)),!1}async function main(){asetaKuuntelijat(),await hallinnoiData()}window.onload=async()=>{main()};export{cykupuu,synkronoiMuutokset,asetaCytoscapenKuuntelijat,kytkeNappaimienKuuntelija,kytkeForminNappaimienKuuntelija,kytkeHakukentanKuuntelija,createBusinessId,tila,lataaTiedosto,tallennaTiedosto,hallinnoiData,asetukset};