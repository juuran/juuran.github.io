import{cy}from"../controller/cykupuu.js";import{Henkilo}from"../model/henkilo.js";import{Suhde}from"../model/suhde.js";import{SuhdeLiitos}from"../model/suhdeliitos.js";import*as Util from"../etc/util.js";import{laskeLahinGridPiste,asetaHenkiloAlapuolelle,asetaHenkiloYlapuolelle,asetaSuhdeAlapuolelle,asetaSuhdeYlapuolelle}from"../view/piirtoalgoritmit.js";import*as Main from"../controller/main.js";function luoHenkiloSolmutDatasta(i){const t=[];for(const a of i.values())t.push(luoHenkiloSolmu(a));cy.add(t)}function luoSuhdeSolmutJaKaaretDatasta(i){const t=[],a=[];for(const e of i.values()){t.push(luoSuhdeSolmu(e));for(const i of e.ylavirtaLiitokset){const t=i.getHenkiloId();a.push(luoKaariIdeillä(t,e.id,i))}for(const i of e.alavirtaLiitokset){const t=i.getHenkiloId();a.push(luoKaariIdeillä(e.id,t,i))}}cy.add(t),cy.add(a)}function muutaHenkiloa(i,t,a,e,o,n,l,s,u,r){const d=i.scratch()._itse.henkilo;if(d.onkoSama(t,a,e,o,n,l,s,u,r))return!1;const h=new Henkilo(d.id,t,a,d.vanhempiSuhteet.slice(),d.pariSuhteet.slice(),null,null,e,o,n,l,s,u,r);return muutaTilaaKonttana(new Array(h),"muuta"),!0}function muutaSuhdetta(i,t,a,e){const o=i.scratch()._itse.suhde;if(o.nimike===t&&o.onkoYhdessa===a&&o.onkoNaimisissa===e)return!1;const n=new Suhde(o.id,t,a,e,o.ylavirtaLiitokset.slice(),o.alavirtaLiitokset.slice());return muutaTilaaKonttana(null,null,new Array(n),"muuta"),!0}function poistaHenkiloSolmu(i,t){const a=Main.tila.naytaTila(),e=[];for(const t of i.vanhempiSuhteet){const o=a.suhteet.get(t.getSuhdeId()),n=o.alavirtaLiitokset.findIndex(((t,a,e)=>i.id===t.getHenkiloId()));if(n>-1){const i=new Suhde(o.id,o.nimike,o.onkoYhdessa,o.onkoNaimisissa,o.ylavirtaLiitokset.slice(),o.alavirtaLiitokset.slice());i.alavirtaLiitokset.splice(n,1),e.push(i)}}for(const t of i.pariSuhteet){const o=a.suhteet.get(t.getSuhdeId()),n=o.ylavirtaLiitokset.findIndex(((t,a,e)=>i.id===t.getHenkiloId()));if(n>-1){const i=new Suhde(o.id,o.nimike,o.onkoYhdessa,o.onkoNaimisissa,o.ylavirtaLiitokset.slice(),o.alavirtaLiitokset.slice());i.ylavirtaLiitokset.splice(n,1),e.push(i)}}muutaTilaaKonttana(new Array(i),"poista",e,"muuta"),cy.remove(t)}function poistaSuhdeSolmu(i,t){const a=Main.tila.naytaTila(),e=[];for(const t of i.ylavirtaLiitokset){const o=a.henkilot.get(t.getHenkiloId()),n=o.pariSuhteet.findIndex(((t,a,e)=>i.id===t.getSuhdeId()));if(n>-1){const i=new Henkilo(o.id,o.etunimet,o.sukunimet,o.vanhempiSuhteet.slice(),o.pariSuhteet.slice(),null,null,o.syntAika,o.kuolAika,o.syntPaikka,o.paaAsPaikka,o.aidinkieli,o.heimo,o.vapaaTieto);i.pariSuhteet.splice(n,1),e.push(i)}}for(const t of i.alavirtaLiitokset){const o=a.henkilot.get(t.getHenkiloId()),n=o.vanhempiSuhteet.findIndex(((t,a,e)=>i.id===t.getSuhdeId()));if(n>-1){const i=new Henkilo(o.id,o.etunimet,o.sukunimet,o.vanhempiSuhteet.slice(),o.pariSuhteet.slice(),null,null,o.syntAika,o.kuolAika,o.syntPaikka,o.paaAsPaikka,o.aidinkieli,o.heimo,o.vapaaTieto);i.vanhempiSuhteet.splice(n,1),e.push(i)}}muutaTilaaKonttana(e,"muuta",new Array(i),"poista"),cy.remove(t)}function lisaaSuhde(i,t,a){const e=new Suhde(Main.createBusinessId(),"",!0,!0,[],[],t.getXPosition(),t.getYPosition()),o=luoSuhdeSolmu(e),n=new Henkilo(t.id,t.etunimet,t.sukunimet,t.vanhempiSuhteet.slice(),t.pariSuhteet.slice(),null,null,t.syntAika,t.kuolAika,t.syntPaikka,t.paaAsPaikka,t.aidinkieli,t.heimo,t.vapaaTieto);return"ylävirtasuhde"===i?(teeLapsiSuhteenLiitokset(e,n,o,a),asetaSuhdeYlapuolelle(o)):"alavirtasuhde"===i&&(teeParisuhteenLiitokset(n,e,o),asetaSuhdeAlapuolelle(o)),muutaTilaaKonttana(new Array(n),"muuta",new Array(e),"lisää"),e}function lisaaHenkilo(i,t,a){const e=new Henkilo(Main.createBusinessId(),"","",[],[],t.getXPosition(),t.getYPosition()),o=luoHenkiloSolmu(e),n=new Suhde(t.id,t.nimike,t.onkoYhdessa,t.onkoNaimisissa,t.ylavirtaLiitokset.slice(),t.alavirtaLiitokset.slice());return"lapsi"===i?(teeLapsiSuhteenLiitokset(n,e,o,a),asetaHenkiloAlapuolelle(o)):"aikuinen"===i&&(teeParisuhteenLiitokset(e,n,o),asetaHenkiloYlapuolelle(o)),muutaTilaaKonttana(new Array(e),"lisää",new Array(n),"muuta"),e}function luoHenkiloTyhjasta(i){const t=new Henkilo(Main.createBusinessId(),"","",[],[],i.x,i.y),a=luoHenkiloSolmu(t);return cy.add(a),muutaTilaaKonttana(new Array(t),"lisää"),t}function muutaTilaaKonttana(i=null,t=null,a=null,e=null,o=!0){const n=Main.tila.naytaTila();let l,s;if(!i&&!a)throw new Error("Jompaa kumpaa pitää muuttaa!");i&&(l=new Map(n.henkilot),i.forEach((i=>muutaMappia(l,i,t))),i.forEach((i=>paivitaGraafinOliota(i)))),a&&(s=new Map(n.suhteet),a.forEach((i=>muutaMappia(s,i,e))),a.forEach((i=>paivitaGraafinOliota(i)))),i&&a?Main.tila.muutaTilaa({...n,henkilot:l,suhteet:s},o):i?Main.tila.muutaTilaa({...n,henkilot:l},o):a&&Main.tila.muutaTilaa({...n,suhteet:s},o)}function muutaMappia(i,t,a){switch(a){case"poista":if(!i.delete(t.id))throw new Error(`Annetiin käsky poistaa, muttei löytynyt alkiota: ${t.id}`);break;case"muuta":if(!i.has(t.id))throw new Error(`Annetiin käsky muokata, muttei löytynyt alkiota: ${t.id}`);i.set(t.id,t);break;case"lisää":if(i.has(t.id))throw new Error(`Annetiin käsky luoda uusi, mutta vastaava löytyi jo: ${t.id}`);i.set(t.id,t);break;default:throw new Error("Tuntematon muuttamiskomento!")}}function paivitaGraafinOliota(i){const t=cy.getElementById(i.id);t.json({data:{label:`${i.getNakyvaNimi()}`}}),t.scratch()._itse.toString=()=>i.toString(),"Henkilo"===i.constructor.name?t.scratch()._itse.henkilo=i:"Suhde"===i.constructor.name&&(t.scratch()._itse.suhde=i),t.flashClass("highlighted",1200)}function teeLapsiSuhteenLiitokset(i,t,a,e){tarkistaKentat(i,t,e);const o=new SuhdeLiitos(t.id,i.id,e);i.alavirtaLiitokset.push(o),t.vanhempiSuhteet.push(o);const n=luoKaariIdeillä(i.id,t.id,o);cy.add([a,n])}function teeParisuhteenLiitokset(i,t,a){tarkistaKentat(t,i);const e=new SuhdeLiitos(i.id,t.id);t.ylavirtaLiitokset.push(e),i.pariSuhteet.push(e);const o=luoKaariIdeillä(i.id,t.id,e);cy.add([a,o])}function tarkistaKentat(i,t,a){if(!i.id||!t.id)throw new Error(`Id on tyhjä: suhde.id='${i.id}', henkilo.id=${t.id}`);if(null===a)throw new Error('Kenttä "onkoBiologinen" ei saa olla null! Käytä eri konstruktoria, jos haluat jättää sen tyhjäksi!')}function luoHenkiloSolmu(i){return{group:"nodes",data:{id:i.id,label:`${i.getNakyvaNimi()}`,type:"ellipse"},classes:"multiline-manual",scratch:{_itse:{henkilo:i,toString:()=>i.toString()}},position:Util.isNumber(i.initialXPosition)?{x:laskeLahinGridPiste(i.initialXPosition),y:laskeLahinGridPiste(i.initialYPosition)}:void 0}}function luoSuhdeSolmu(i){return{group:"nodes",data:{id:i.id,label:`${i.getNakyvaNimi()}`,type:"round-diamond"},scratch:{_itse:{suhde:i,toString:()=>i.toString()}},position:Util.isNumber(i.initialXPosition)?{x:laskeLahinGridPiste(i.initialXPosition),y:laskeLahinGridPiste(i.initialYPosition)}:void 0}}function luoKaariIdeillä(i,t,a){return{group:"edges",data:{id:`${i}_${t}`,source:i,target:t},classes:"round-taxi",scratch:{_itse:{suhdeLiitos:a,toString:()=>a.toString()}}}}export{luoHenkiloSolmutDatasta,luoSuhdeSolmutJaKaaretDatasta,muutaHenkiloa,muutaSuhdetta,poistaHenkiloSolmu,poistaSuhdeSolmu,lisaaSuhde,lisaaHenkilo,luoHenkiloTyhjasta,muutaTilaaKonttana};