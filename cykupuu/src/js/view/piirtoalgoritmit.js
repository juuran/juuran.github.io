import{Cykupuu as Cyk}from"../controller/cykupuu.js";import{cy}from"../controller/cykupuu.js";import*as Util from"../etc/util.js";import{asetukset,cykupuu,tila}from"../controller/main.js";import{muutaTilaaKonttana}from"../business/alkiot.js";function panoroiGraafi(t){cy.delay(40),cy.animate({pan:t.pan,zoom:t.zoom,easing:"ease-in-out",duration:360}),cykupuu.enabloiZoomit(t)}function liikutaPanorointia(t){switch(t){case"ylös":cy.panBy({x:0,y:1.1*Cyk.PIIRTO_STEP});break;case"alas":cy.panBy({x:0,y:-1.1*Cyk.PIIRTO_STEP});break;case"vasemmalle":cy.panBy({x:1.1*Cyk.PIIRTO_STEP,y:0});break;case"oikealle":cy.panBy({x:-1.1*Cyk.PIIRTO_STEP,y:0});break;default:throw new Error("Suunta pitää antaa!")}}function tallennaTamanhetkinenPanorointi(){const t={...tila.naytaTila()};t.panorama={...t.panorama},t.panorama.pan={x:cy.pan().x,y:cy.pan().y},t.panorama.zoom=cy.zoom(),tila.muutaTilaa(t),cykupuu.kirjoitaStatus("Uusi oletusnäkymä tallennettu.")}function zoomaa(t){const a=cy.zoom(),o=document.getElementById("cy").getBoundingClientRect(),e=o.height,i=o.width;if("sisään"===t){const t=a*Cyk.ZOOM_KERROIN;cy.zoom({level:t,renderedPosition:{x:i/2,y:e/2}})}else if("ulos"===t){const t=a*(1/Cyk.ZOOM_KERROIN);cy.zoom({level:t,renderedPosition:{x:i/2,y:e/2}})}}function voiZoomata(t,a){const o=a||cy.zoom();return"sisään"===t?o!==Cyk.ZOOM_MAX:"ulos"===t?o!==Cyk.ZOOM_MIN:void 0}function laskeLahinGridPiste(t){const a=Cyk.GRID_STEP;return Math.round(t/a)*a}function asetaGridiin(t){const a=t.target;for(const t of a){const a=getPositions(t),o=laskeLahinGridPiste(a.x),e=laskeLahinGridPiste(a.y);t.json({position:{x:o,y:e}})}}function asetaSuhdeYlapuolelle(t){t.position.y=laskeLahinGridPiste(t.position.y)-(Cyk.SUHTEEN_MARGIN+Cyk.PIIRTO_STEP)}function asetaSuhdeAlapuolelle(t){t.position.y=laskeLahinGridPiste(t.position.y)+Cyk.SUHTEEN_MARGIN}function asetaHenkiloYlapuolelle(t){t.position.y=laskeLahinGridPiste(t.position.y)-Cyk.SUHTEEN_MARGIN}function asetaHenkiloAlapuolelle(t){t.position.y=laskeLahinGridPiste(t.position.y)+(Cyk.PIIRTO_STEP+Cyk.SUHTEEN_MARGIN)}function siirraSolmua(t){const a=cy.nodes(":selected");switch(t){case"vasemmalle":a.forEach((t=>{const a=getPositions(t);t.json({position:{x:a.x-Cyk.GRID_STEP}})}));break;case"oikealle":a.forEach((t=>{const a=getPositions(t);t.json({position:{x:a.x+Cyk.GRID_STEP}})}));break;case"ylös":a.forEach((t=>{const a=getPositions(t);t.json({position:{y:a.y-Cyk.GRID_STEP}})}));break;case"alas":a.forEach((t=>{const a=getPositions(t);t.json({position:{y:a.y+Cyk.GRID_STEP}})}));break;default:throw new Error("Suunta pitää antaa!")}}function getPositions(t){return t.json().position}function vaihdaValituksiSolmu(t){const a=cy.nodes(":selected");if(0===a.length)return void valitseJokin(t);const o=a[0];switch(t){case"vasemmainen":let t=haeSamallaTasollaOlevat("vaaka",o,1);0===t.length&&(t=haeSamallaTasollaOlevat("vaaka",o,2)),t=t.filter((t=>getPositions(t).x<getPositions(o).x)).sort(((t,a)=>sorttaa(getPositions(t).x,getPositions(a).x))),t.length>0&&(a.unselect(),t[0].select());break;case"oikeammainen":let e=haeSamallaTasollaOlevat("vaaka",o,1);0===e.length&&(e=haeSamallaTasollaOlevat("vaaka",o,2)),e=e.filter((t=>getPositions(t).x>getPositions(o).x)).sort(((t,a)=>sorttaa(getPositions(a).x,getPositions(t).x))),e.length>0&&(a.unselect(),e[0].select());break;case"ylempi":let i=haeSamallaTasollaOlevat("pysty",o,2);0===i.length&&(i=haeSamallaTasollaOlevat("pysty",o,4)),i=i.filter((t=>getPositions(t).y<getPositions(o).y)).sort(((t,a)=>sorttaa(getPositions(t).y,getPositions(a).y))),i.length>0&&(a.unselect(),i[0].select());break;case"alempi":let s=haeSamallaTasollaOlevat("pysty",o,2);0===s.length&&(s=haeSamallaTasollaOlevat("pysty",o,4)),s=s.filter((t=>getPositions(t).y>getPositions(o).y)).sort(((t,a)=>sorttaa(getPositions(a).y,getPositions(t).y))),s.length>0&&(a.unselect(),s[0].select());break;default:throw new Error("Suunta pitää antaa!")}}function sorttaa(t,a){return t>a?-1:t===a?0:1}function haeSamallaTasollaOlevat(t,a,o){const e=cy.nodes().toArray();return"vaaka"===t?e.filter((t=>t!==a&&(getPositions(t).y<=getPositions(a).y+o*Cyk.GRID_STEP&&getPositions(t).y>=getPositions(a).y-o*Cyk.GRID_STEP))):"pysty"===t?e.filter((t=>t!==a&&(getPositions(t).x<=getPositions(a).x+o*Cyk.GRID_STEP&&getPositions(t).x>=getPositions(a).x-o*Cyk.GRID_STEP))):void 0}function valitseJokin(t){let a;try{if(a=cy.nodes().toArray(),0===a.length)throw new Error("Graafi oli tyhjä")}catch(t){return void Util.logDebug(`Ei voitu valita nuolinäppäimillä solmua${t.message?`, koska: "${t.message}"`:""}.`)}switch(t){case"vasemmainen":a.sort(((t,a)=>sorttaa(getPositions(a).x,getPositions(t).x))),a[0].select();break;case"oikeammainen":a.sort(((t,a)=>sorttaa(getPositions(t).x,getPositions(a).x))),a[0].select();break;case"ylempi":a.sort(((t,a)=>sorttaa(getPositions(a).y,getPositions(t).y))),a[0].select();break;case"alempi":a.sort(((t,a)=>sorttaa(getPositions(t).y,getPositions(a).y))),a[0].select();break;default:return}}function piirraTarkemmatTiedot(t,a){const o=t.target,e=o.scratch()._itse;let i;if(!e)return;if(e.suhde)i=e.suhde;else{if(!e.henkilo)return;i=e.henkilo}const s=asetukset._naytaValitunTiedot(),n=asetukset._naytaSukulaisuus();"sama"===a&&(a=s?"näytä":"piilota"),"näytä"===a||"mouseover"===a&&!1===s&&!1===n?(asetukset.naytaLaajatTiedot()?(o.toggleClass("taysi-tieto",!0),o.toggleClass("nayta-lisatieto",!1)):(o.toggleClass("taysi-tieto",!1),o.toggleClass("nayta-lisatieto",!0)),o.json({data:{label:`${i.getTaydetTiedot()}`}})):("piilota"===a&&!1===n||"mouseout"===a&&!1===s&&!1===n)&&(o.toggleClass("nayta-lisatieto",!1),o.toggleClass("taysi-tieto",!1),o.json({data:{label:`${i.getNakyvaNimi()}`}}))}export{panoroiGraafi,liikutaPanorointia,tallennaTamanhetkinenPanorointi,zoomaa,voiZoomata,laskeLahinGridPiste,asetaGridiin,asetaHenkiloYlapuolelle,asetaHenkiloAlapuolelle,asetaSuhdeYlapuolelle,asetaSuhdeAlapuolelle,siirraSolmua,vaihdaValituksiSolmu,piirraTarkemmatTiedot};